<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> TOOL-LC79</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #0a0e17;
            --secondary: #00d4ff;
            --accent: #ff375f;
            --success: #00ff9d;
            --warning: #ffb547;
            --text: #e0e0ff;
            --text-muted: #8a8dab;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', monospace;
        }
        body {
            background: var(--primary);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 700px;
            background: rgba(16, 22, 36, 0.95);
            border-radius: 25px;
            border: 2px solid rgba(0, 212, 255, 0.3);
            box-shadow: 0 20px 50px rgba(0, 212, 255, 0.15);
            overflow: hidden;
        }
        .header {
            padding: 25px 30px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
        }
        .header h1 {
            font-size: 1.8rem;
            background: linear-gradient(to right, var(--secondary), var(--success));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
        }
        .system-status {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-active {
            color: var(--success);
        }
        .status-waiting {
            color: var(--warning);
        }
        .status-inactive {
            color: var(--text-muted);
        }
        .session-tracker {
            padding: 25px 30px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .tracker-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .tracker-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 10px;
        }
        .tracker-value {
            font-size: 2rem;
            font-weight: 900;
        }
        .current-session {
            color: var(--secondary);
        }
        .next-session {
            color: var(--warning);
        }
        .last-session {
            color: var(--success);
        }
        .prediction-main {
            padding: 30px;
            text-align: center;
        }
        .prediction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .pred-label {
            font-size: 1.2rem;
            color: var(--text);
        }
        .auto-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 8px 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }
        .toggle-switch {
            width: 40px;
            height: 20px;
            background: rgba(255, 55, 95, 0.3);
            border-radius: 10px;
            position: relative;
            transition: all 0.3s;
        }
        .toggle-switch.active {
            background: rgba(0, 255, 157, 0.3);
        }
        .toggle-knob {
            position: absolute;
            width: 16px;
            height: 16px;
            background: var(--accent);
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s;
        }
        .toggle-switch.active .toggle-knob {
            left: 22px;
            background: var(--success);
        }
        .prediction-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            padding: 40px 20px;
            margin: 20px 0;
            border: 2px solid transparent;
            transition: all 0.5s;
            position: relative;
            overflow: hidden;
        }
        .prediction-box.waiting {
            border-color: var(--warning);
            background: rgba(255, 183, 71, 0.05);
        }
        .prediction-box.ready {
            border-color: var(--secondary);
            background: rgba(0, 212, 255, 0.05);
        }
        .prediction-box.correct {
            border-color: var(--success);
            background: rgba(0, 255, 157, 0.05);
            box-shadow: 0 0 40px rgba(0, 255, 157, 0.3);
        }
        .prediction-box.incorrect {
            border-color: var(--accent);
            background: rgba(255, 55, 95, 0.05);
            box-shadow: 0 0 40px rgba(255, 55, 95, 0.3);
        }
        .result-display {
            font-size: 4rem;
            font-weight: 900;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 5px;
        }
        .tai-result { color: var(--accent); }
        .xiu-result { color: var(--secondary); }
        .confidence-display {
            font-size: 1.5rem;
            color: var(--warning);
            margin-top: 15px;
        }
        .session-target {
            margin-top: 25px;
            font-size: 1.1rem;
            color: var(--text-muted);
        }
        .target-id {
            color: var(--success);
            font-weight: bold;
            font-size: 1.3rem;
            margin-top: 5px;
        }
        .prediction-history {
            padding: 0 30px 30px;
        }
        .history-title {
            font-size: 1.2rem;
            color: var(--warning);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .history-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        .stat-box {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px 15px;
            text-align: center;
        }
        .stat-value {
            font-size: 2.2rem;
            font-weight: 900;
            margin: 10px 0;
        }
        .correct-stat { color: var(--success); }
        .incorrect-stat { color: var(--accent); }
        .accuracy-stat { color: var(--warning); }
        .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        .history-log {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .log-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.9rem;
        }
        .log-item:last-child { border-bottom: none; }
        .log-correct { color: var(--success); }
        .log-incorrect { color: var(--accent); }
        .log-waiting { color: var(--warning); }
        .control-panel {
            padding: 0 30px 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .btn {
            padding: 18px 25px;
            border-radius: 15px;
            border: none;
            font-weight: bold;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(90deg, var(--secondary), #0088cc);
            color: white;
        }
        .btn-primary:hover {
            background: linear-gradient(90deg, #0088cc, var(--secondary));
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.4);
        }
        .btn-danger {
            background: linear-gradient(90deg, var(--accent), #cc0044);
            color: white;
        }
        .btn-danger:hover {
            background: linear-gradient(90deg, #cc0044, var(--accent));
            box-shadow: 0 5px 20px rgba(255, 55, 95, 0.4);
        }
        .footer {
            padding: 20px 30px;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.85rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
        }
        .signature {
            color: var(--success);
            font-weight: bold;
            margin-top: 8px;
            letter-spacing: 1px;
        }
        @media (max-width: 650px) {
            .container { border-radius: 20px; }
            .session-tracker { grid-template-columns: 1fr; }
            .history-stats { grid-template-columns: 1fr; }
            .control-panel { grid-template-columns: 1fr; }
            .result-display { font-size: 3rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1><i class="fas fa-crown"></i> TAIXIU.AI</h1>
            <div class="system-status">
                <div class="status-item">
                    <i class="fas fa-circle" id="apiStatus"></i>
                    <span>Kết nối API</span>
                </div>
                <div class="status-item">
                    <i class="fas fa-circle" id="autoStatus"></i>
                    <span id="autoStatusText">Tự động: TẮT</span>
                </div>
                <div class="status-item">
                    <i class="fas fa-circle" id="predictStatus"></i>
                    <span id="predictStatusText">Đang chờ phiên mới</span>
                </div>
            </div>
        </div>

        <!-- THEO DÕI PHIÊN -->
        <div class="session-tracker">
            <div class="tracker-box">
                <div class="tracker-label">PHIÊN ĐANG DIỄN RA</div>
                <div id="currentSession" class="tracker-value current-session">#---</div>
            </div>
            <div class="tracker-box">
                <div class="tracker-label">PHIÊN SẮP DỰ ĐOÁN</div>
                <div id="targetSession" class="tracker-value next-session">#---</div>
            </div>
            <div class="tracker-box">
                <div class="tracker-label">PHIÊN GẦN NHẤT</div>
                <div id="lastSession" class="tracker-value last-session">#---</div>
            </div>
        </div>

        <!-- DỰ ĐOÁN CHÍNH -->
        <div class="prediction-main">
            <div class="prediction-header">
                <div class="pred-label">
                    <i class="fas fa-brain-circuit"></i> DỰ ĐOÁN 
                </div>
                <div class="auto-toggle" id="autoToggle">
                    <div class="toggle-switch" id="toggleSwitch">
                        <div class="toggle-knob"></div>
                    </div>
                    <span id="toggleText">TỰ ĐỘNG: TẮT</span>
                </div>
            </div>
            
            <div id="predictionBox" class="prediction-box waiting">
                <div id="resultDisplay" class="result-display">---</div>
                <div id="confidenceDisplay" class="confidence-display">Đang khởi động thuật toán...</div>
                
                <div class="session-target">
                    <div>ĐANG CHỜ PHIÊN HOÀN TẤT:</div>
                    <div id="waitingSession" class="target-id">#---</div>
                </div>
            </div>

            <div class="session-target" style="margin-top: 20px;">
                <div>DỰ ĐOÁN CHO PHIÊN:</div>
                <div id="predictionForSession" class="target-id">#---</div>
            </div>
        </div>

        <!-- LỊCH SỬ DỰ ĐOÁN -->
        <div class="prediction-history">
            <div class="history-title">
                <i class="fas fa-chart-network"></i> BẢNG THỐNG KÊ
            </div>
            
            <div class="history-stats">
                <div class="stat-box">
                    <div class="stat-value correct-stat" id="statCorrect">0</div>
                    <div class="stat-label">DỰ ĐOÁN ĐÚNG</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value incorrect-stat" id="statIncorrect">0</div>
                    <div class="stat-label">DỰ ĐOÁN SAI</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value accuracy-stat" id="statAccuracy">0%</div>
                    <div class="stat-label">ĐỘ CHÍNH XÁC VIP</div>
                </div>
            </div>

            <div class="history-log" id="historyLog">
                <div class="log-item">
                    <span>Hệ thống VIP PRO đang khởi động...</span>
                    <span class="log-waiting">VIP PRO</span>
                </div>
            </div>
        </div>

        <!-- ĐIỀU KHIỂN -->
        <div class="control-panel">
            <button id="manualPredictBtn" class="btn btn-primary">
                <i class="fas fa-bolt"></i> DỰ ĐOÁN 
            </button>
            <button id="resetBtn" class="btn btn-danger">
                <i class="fas fa-sync-alt"></i> RESET 
            </button>
        </div>

        <!-- FOOTER -->
        <div class="footer">
            <div>Hệ thống với thuật toán AI nâng cao | API: wtx.tele68.com</div>
            <div class="signature">Created by LUKZANMODZ</div>
            <div style="margin-top: 10px; font-size: 0.8rem; color: var(--warning);">
                <i class="fas fa-star"></i>EDITION - Thuật toán đã được nâng cấp tối đa
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://wtx.tele68.com/v1/tx/lite-sessions';
        
        // Biến hệ thống VIP
        let systemState = {
            autoMode: false,
            currentSessionId: null,
            lastSessionId: null,
            targetSessionId: null,
            isProcessing: false,
            pollInterval: null,
            dataCache: [],
            predictions: [],
            apiErrorCount: 0,
            algorithmLevel: ''  
        };

        document.addEventListener('DOMContentLoaded', function() {
            console.log('TAIXIU.AI - Hệ thống đang khởi động...');
            initializeVIPUI();
            initializeVIPSystem();
            startVIPPolling();
        });

        function initializeVIPUI() {
            document.getElementById('autoToggle').addEventListener('click', toggleAutoMode);
            document.getElementById('manualPredictBtn').addEventListener('click', manualVIPPrediction);
            document.getElementById('resetBtn').addEventListener('click', resetVIPSystem);
            updateVIPClock();
            setInterval(updateVIPClock, 1000);
        }

        function updateVIPClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('vi-VN');
            document.getElementById('predictStatusText').innerHTML = 
                `<i class="fas fa-clock"></i> ${timeStr} `;
        }

        function initializeVIPSystem() {
            const savedPredictions = localStorage.getItem('taixiu_predictions');
            if (savedPredictions) {
                systemState.predictions = JSON.parse(savedPredictions);
                updateVIPStatsDisplay();
            }
            startVIPPolling();
        }

        // ==================== POLLING VIP PRO ====================
        function startVIPPolling() {
            if (systemState.pollInterval) clearInterval(systemState.pollInterval);
            
            systemState.pollInterval = setInterval(async () => {
                if (systemState.isProcessing) return;
                
                try {
                    systemState.isProcessing = true;
                    await checkNewVIPSession();
                } catch (error) {
                    console.error('Error:', error);
                    updateVIPStatus('api', 'error');
                    systemState.apiErrorCount++;
                } finally {
                    systemState.isProcessing = false;
                }
            }, 3000);
            
            setTimeout(() => checkNewVIPSession(), 1000);
        }

        async function checkNewVIPSession() {
            updateVIPStatus('api', 'loading');
            
            try {
                const response = await fetch(API_URL + '?t=' + Date.now());
                if (!response.ok) throw new Error('API VIP không phản hồi');
                
                const data = await response.json();
                updateVIPStatus('api', 'active');
                systemState.apiErrorCount = 0;
                
                if (!data.list || data.list.length === 0) throw new Error('Dữ liệu trống');
                
                const latestSession = data.list[0];
                const latestSessionId = latestSession.id;
                
                // Cập nhật cache với nhiều dữ liệu hơn cho VIP
                systemState.dataCache = data.list.slice(0, 50);
                
                if (systemState.lastSessionId === null) {
                    systemState.currentSessionId = latestSessionId;
                    systemState.lastSessionId = latestSessionId;
                    systemState.targetSessionId = latestSessionId + 1;
                    updateVIPSessionDisplay();
                    showVIPNotification(`VIP PRO: Đã kết nối. Phiên #${latestSessionId}`, 'success');
                } else if (latestSessionId > systemState.lastSessionId) {
                    systemState.lastSessionId = latestSessionId;
                    checkVIPPredictionResult();
                    systemState.currentSessionId = latestSessionId;
                    systemState.targetSessionId = latestSessionId + 1;
                    updateVIPSessionDisplay();
                    showVIPNotification(`VIP: Phát hiện phiên mới #${latestSessionId}`, 'info');
                    
                    if (systemState.autoMode) {
                        setTimeout(() => performVIPPrediction(), 1500);
                    }
                } else {
                    updateVIPSessionDisplay();
                    updateVIPStatus('predict', 'waiting');
                }
                
            } catch (error) {
                console.error('Lỗi VIP:', error);
                updateVIPStatus('api', 'error');
                useVIPSampleData();
            }
        }

        function analyzeVIPData(sessions) {
            if (sessions.length < 5) {
                return { result: 'TAI', confidence: 50 };
            }
            
            const recentSessions = sessions.slice(0, 15);

            const timeSeriesAnalysis = analyzeTimeSeriesVIP(recentSessions);

            const markovAnalysis = analyzeMarkovChainVIP(recentSessions);

            const pointPatternAnalysis = analyzePointPatternsVIP(recentSessions);

            const trendAnalysis = analyzeLongTermTrendVIP(sessions);

            const cycleAnalysis = detectCyclesVIP(recentSessions);

            const results = [
                { type: 'time', result: timeSeriesAnalysis.result, weight: 1.5, confidence: timeSeriesAnalysis.confidence },
                { type: 'markov', result: markovAnalysis.result, weight: 1.3, confidence: markovAnalysis.confidence },
                { type: 'point', result: pointPatternAnalysis.result, weight: 1.2, confidence: pointPatternAnalysis.confidence },
                { type: 'trend', result: trendAnalysis.result, weight: 1.0, confidence: trendAnalysis.confidence },
                { type: 'cycle', result: cycleAnalysis.result, weight: 0.8, confidence: cycleAnalysis.confidence }
            ];

            let taiScore = 50;
            let xiuScore = 50;
            
            results.forEach(r => {
                if (r.result === 'TAI') {
                    taiScore += (r.confidence - 50) * (r.weight / 5);
                } else {
                    xiuScore += (r.confidence - 50) * (r.weight / 5);
                }
            });

            const volatility = calculateVolatilityVIP(recentSessions);
            if (volatility > 0.7) {

                taiScore *= 0.9;
                xiuScore *= 0.9;
            }

            const totalScore = taiScore + xiuScore;
            const taiPercent = Math.max(30, Math.min(90, Math.round((taiScore / totalScore) * 100)));
            const xiuPercent = 100 - taiPercent;
            
            const finalResult = taiPercent > xiuPercent ? 'TAI' : 'XIU';
            const finalConfidence = Math.max(taiPercent, xiuPercent);
            
            console.log('VIP Analysis:', {
                taiPercent,
                xiuPercent,
                finalResult,
                finalConfidence,
                analyses: results.map(r => `${r.type}: ${r.result} (${r.confidence}%)`)
            });
            
            return {
                result: finalResult,
                confidence: finalConfidence,
                detailedAnalysis: {
                    timeSeries: timeSeriesAnalysis,
                    markov: markovAnalysis,
                    pointPattern: pointPatternAnalysis,
                    trend: trendAnalysis,
                    cycles: cycleAnalysis,
                    volatility: volatility
                }
            };
        }

        // 1. PHÂN TÍCH CHUỖI THỜI GIAN NÂNG CAO
        function analyzeTimeSeriesVIP(sessions) {
            const results = sessions.map(s => s.resultTruyenThong);
            const points = sessions.map(s => s.point);
            
            // Phát hiện xu hướng
            let trend = 'neutral';
            const recentResults = results.slice(0, 5);
            const taiCount = recentResults.filter(r => r === 'TAI').length;
            const xiuCount = recentResults.length - taiCount;
            
            // Phát hiện chuỗi
            let currentStreak = 1;
            const currentType = results[0];
            for (let i = 1; i < results.length; i++) {
                if (results[i] === currentType) currentStreak++;
                else break;
            }
            
            // Phát hiện mẫu xen kẽ
            let alternatingPattern = false;
            if (results.length >= 4) {
                alternatingPattern = true;
                for (let i = 0; i < Math.min(3, results.length - 1); i++) {
                    if (results[i] === results[i + 1]) {
                        alternatingPattern = false;
                        break;
                    }
                }
            }
            
            // Phân tích điểm số
            const avgPoint = points.slice(0, 5).reduce((a, b) => a + b, 0) / Math.min(5, points.length);
            
            // Logic dự đoán nâng cao
            let result = 'TAI';
            let confidence = 50;
            
            if (currentStreak >= 3) {
                // Chuỗi dài -> dễ đảo chiều
                result = currentType === 'TAI' ? 'XIU' : 'TAI';
                confidence = 55 + Math.min(currentStreak * 5, 30);
            } else if (alternatingPattern) {
                // Đang xen kẽ -> dự đoán ngược lại
                result = results[0] === 'TAI' ? 'XIU' : 'TAI';
                confidence = 65;
            } else if (avgPoint > 11) {
                // Điểm cao -> nghiêng TAI
                result = 'TAI';
                confidence = 50 + Math.min((avgPoint - 10.5) * 4, 30);
            } else if (avgPoint < 10) {
                // Điểm thấp -> nghiêng XIU
                result = 'XIU';
                confidence = 50 + Math.min((10.5 - avgPoint) * 4, 30);
            } else {
                // Theo tỷ lệ gần đây
                result = taiCount > xiuCount ? 'TAI' : 'XIU';
                confidence = 50 + Math.abs(taiCount - xiuCount) * 8;
            }
            
            return { result, confidence: Math.min(90, confidence) };
        }

        // 2. PHÂN TÍCH MARKOV CHAIN NÂNG CAO
        function analyzeMarkovChainVIP(sessions) {
            if (sessions.length < 4) return { result: 'TAI', confidence: 50 };
            
            const results = sessions.map(s => s.resultTruyenThong);

            let transitions = {
                'TAI->TAI': 0, 'TAI->XIU': 0,
                'XIU->XIU': 0, 'XIU->TAI': 0
            };
            
            for (let i = 1; i < results.length; i++) {
                const key = `${results[i-1]}->${results[i]}`;
                if (transitions[key] !== undefined) transitions[key]++;
            }
            
            const currentState = results[0];
            let taiProb = 50;
            
            if (currentState === 'TAI') {
                const total = transitions['TAI->TAI'] + transitions['TAI->XIU'];
                taiProb = total > 0 ? Math.round((transitions['TAI->TAI'] / total) * 100) : 50;
            } else {
                const total = transitions['XIU->TAI'] + transitions['XIU->XIU'];
                taiProb = total > 0 ? Math.round((transitions['XIU->TAI'] / total) * 100) : 50;
            }
            
            // Điều chỉnh dựa trên độ ổn định
            const totalTransitions = Object.values(transitions).reduce((a, b) => a + b, 0);
            const stability = totalTransitions > 0 ? 
                Math.max(transitions['TAI->TAI'], transitions['XIU->XIU']) / totalTransitions : 0.5;
            
            if (stability > 0.7) {
                // Hệ thống ổn định -> tăng độ tin cậy
                taiProb = taiProb > 50 ? Math.min(85, taiProb + 10) : Math.max(15, taiProb - 10);
            }
            
            const result = taiProb > 50 ? 'TAI' : 'XIU';
            const confidence = Math.max(40, Math.min(90, Math.abs(taiProb - 50) * 2 + 50));
            
            return { result, confidence };
        }

        // 3. PHÂN TÍCH MẪU ĐIỂM SỐ
        function analyzePointPatternsVIP(sessions) {
            const points = sessions.map(s => s.point);
            const recentPoints = points.slice(0, 8);
            
            // Tính các chỉ số thống kê
            const mean = recentPoints.reduce((a, b) => a + b, 0) / recentPoints.length;
            const variance = recentPoints.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / recentPoints.length;
            const stdDev = Math.sqrt(variance);
            
            // Phát hiện xu hướng điểm
            let pointTrend = 'stable';
            if (recentPoints.length >= 3) {
                const firstHalf = recentPoints.slice(0, 4).reduce((a, b) => a + b, 0) / 4;
                const secondHalf = recentPoints.slice(4).reduce((a, b) => a + b, 0) / 4;
                pointTrend = secondHalf > firstHalf ? 'increasing' : secondHalf < firstHalf ? 'decreasing' : 'stable';
            }
            
            // Logic dự đoán dựa trên điểm
            let result = 'TAI';
            let confidence = 50;
            
            if (mean > 11.5) {
                result = 'TAI';
                confidence = 50 + Math.min((mean - 10.5) * 6, 35);
            } else if (mean < 9.5) {
                result = 'XIU';
                confidence = 50 + Math.min((10.5 - mean) * 6, 35);
            } else if (pointTrend === 'increasing' && mean > 10.5) {
                result = 'TAI';
                confidence = 65;
            } else if (pointTrend === 'decreasing' && mean < 10.5) {
                result = 'XIU';
                confidence = 65;
            } else if (stdDev < 2) {
                // Độ lệch chuẩn thấp -> dễ dự đoán
                result = mean > 10.5 ? 'TAI' : 'XIU';
                confidence = 70;
            } else {
                // Trường hợp trung tính
                result = Math() > 0.5 ? 'TAI' : 'XIU';
                confidence = 55;
            }
            
            return { result, confidence: Math.min(85, confidence) };
        }

        // 4. PHÂN TÍCH XU HƯỚNG DÀI HẠN
        function analyzeLongTermTrendVIP(allSessions) {
            if (allSessions.length < 20) return { result: 'TAI', confidence: 50 };
            
            const sampleSize = Math.min(30, allSessions.length);
            const sample = allSessions.slice(0, sampleSize);
            
            const taiCount = sample.filter(s => s.resultTruyenThong === 'TAI').length;
            const xiuCount = sample.length - taiCount;
            
            const taiRate = taiCount / sample.length;
            const imbalance = Math.abs(taiRate - 0.5);
            
            let result = taiRate > 0.5 ? 'TAI' : 'XIU';
            let confidence = 50;
            
            if (imbalance > 0.2) {
                // Mất cân bằng lớn -> có thể điều chỉnh
                result = taiRate > 0.5 ? 'XIU' : 'TAI';
                confidence = 50 + imbalance * 40;
            } else {
                // Cân bằng -> dựa trên xu hướng gần đây
                const recent = sample.slice(0, 10);
                const recentTai = recent.filter(s => s.resultTruyenThong === 'TAI').length;
                result = recentTai > 5 ? 'TAI' : 'XIU';
                confidence = 55;
            }
            
            return { result, confidence: Math.min(80, confidence) };
        }

        // 5. PHÁT HIỆN CHU KỲ
        function detectCyclesVIP(sessions) {
            if (sessions.length < 8) return { result: 'TAI', confidence: 50 };
            
            const results = sessions.map(s => s.resultTruyenThong);
            const points = sessions.map(s => s.point);
            
            // Tìm chu kỳ đơn giản (2-4 phiên)
            let hasCycle = false;
            let cycleLength = 0;
            
            for (let len = 2; len <= 4; len++) {
                if (results.length >= len * 2) {
                    const first = results.slice(0, len).join('');
                    const second = results.slice(len, len * 2).join('');
                    if (first === second) {
                        hasCycle = true;
                        cycleLength = len;
                        break;
                    }
                }
            }
            
            if (hasCycle) {
                // Dự đoán theo chu kỳ
                const cycle = results.slice(0, cycleLength);
                const nextInCycle = cycle[0]; // Vì cycle lặp lại
                const result = nextInCycle === 'TAI' ? 'XIU' : 'TAI'; // Ngược lại với đầu chu kỳ
                return { result, confidence: 75 };
            }
            
            // Kiểm tra chu kỳ điểm
            const recentPoints = points.slice(0, 6);
            const pointPatterns = [];
            for (let i = 0; i < recentPoints.length - 2; i++) {
                const pattern = recentPoints.slice(i, i + 3).map(p => p > 10.5 ? 'H' : 'L').join('');
                pointPatterns.push(pattern);
            }
            
            // Nếu có mẫu điểm lặp lại
            if (pointPatterns.length >= 2 && pointPatterns[0] === pointPatterns[1]) {
                const lastPattern = recentPoints.slice(-3).map(p => p > 10.5 ? 'H' : 'L').join('');
                const patternType = lastPattern.includes('H') ? 'TAI' : 'XIU';
                return { result: patternType, confidence: 70 };
            }
            
            return { result: 'TAI', confidence: 50 };
        }

        // TÍNH ĐỘ BIẾN ĐỘNG
        function calculateVolatilityVIP(sessions) {
            if (sessions.length < 3) return 0.5;
            
            const results = sessions.map(s => s.resultTruyenThong);
            let changes = 0;
            
            for (let i = 1; i < results.length; i++) {
                if (results[i] !== results[i-1]) changes++;
            }
            
            return changes / (results.length - 1);
        }

        // ==================== THỰC HIỆN DỰ ĐOÁN VIP ====================
        function performVIPPrediction() {
            if (systemState.dataCache.length < 5) {
                showVIPNotification('VIP: Cần ít nhất 5 phiên để phân tích', 'warning');
                return;
            }
            
            updateVIPStatus('predict', 'processing');
            
            const analysis = analyzeVIPData(systemState.dataCache);
            
            const prediction = {
                id: Date.now(),
                prediction: analysis.result,
                confidence: analysis.confidence,
                targetSession: systemState.targetSessionId,
                createdAt: new Date().toISOString(),
                verified: false,
                actual: null,
                correct: null,
                algorithm: systemState.algorithmLevel,
                detailed: analysis.detailedAnalysis
            };
            
            systemState.predictions.push(prediction);
            updateVIPPredictionBox('ready', prediction.prediction, `${prediction.confidence}% (VIP PRO)`);
            updateVIPSessionDisplay();
            addVIPHistoryLog(prediction);
            saveVIPPredictions();
            showVIPNotification(`VIP: Dự đoán #${prediction.targetSession} - ${prediction.prediction}`, 'info');
            updateVIPStatus('predict', 'waiting');
        }

        function checkVIPPredictionResult() {
            if (systemState.predictions.length === 0) return;
            
            const lastPrediction = systemState.predictions[systemState.predictions.length - 1];
            
            if (lastPrediction.verified === false && lastPrediction.targetSession === systemState.lastSessionId) {
                const actualSession = systemState.dataCache.find(s => s.id === lastPrediction.targetSession);
                
                if (actualSession) {
                    const actualResult = actualSession.resultTruyenThong;
                    const isCorrect = lastPrediction.prediction === actualResult;
                    
                    lastPrediction.actual = actualResult;
                    lastPrediction.correct = isCorrect;
                    lastPrediction.verified = true;
                    lastPrediction.verifiedAt = new Date().toISOString();
                    
                    updateVIPPredictionBox(isCorrect ? 'correct' : 'incorrect', 
                                          lastPrediction.prediction, 
                                          `${lastPrediction.confidence}% (${isCorrect ? 'VIP ĐÚNG' : 'VIP SAI'})`);
                    
                    updateVIPStatsDisplay();
                    addVIPHistoryLog(lastPrediction);
                    
                    showVIPNotification(`VIP #${lastPrediction.targetSession}: ${isCorrect ? 'ĐÚNG' : 'SAI'}`, 
                                     isCorrect ? 'success' : 'error');
                    
                    saveVIPPredictions();
                }
            }
        }

        function updateVIPSessionDisplay() {
            document.getElementById('currentSession').textContent = 
                systemState.currentSessionId ? `#${systemState.currentSessionId}` : '#---';
            document.getElementById('targetSession').textContent = 
                systemState.targetSessionId ? `#${systemState.targetSessionId}` : '#---';
            document.getElementById('lastSession').textContent = 
                systemState.lastSessionId ? `#${systemState.lastSessionId}` : '#---';
            document.getElementById('waitingSession').textContent = 
                systemState.currentSessionId ? `#${systemState.currentSessionId}` : '#---';
            document.getElementById('predictionForSession').textContent = 
                systemState.targetSessionId ? `#${systemState.targetSessionId}` : '#---';
        }

        function updateVIPPredictionBox(state, result, confidence) {
            const box = document.getElementById('predictionBox');
            const resultEl = document.getElementById('resultDisplay');
            const confidenceEl = document.getElementById('confidenceDisplay');
            
            box.className = 'prediction-box ' + state;
            resultEl.textContent = result;
            resultEl.className = 'result-display ' + (result === 'TAI' ? 'tai-result' : 'xiu-result');
            confidenceEl.textContent = confidence;
            
            box.style.transform = 'scale(1.05)';
            setTimeout(() => { box.style.transform = 'scale(1)'; }, 300);
        }

        function updateVIPStatsDisplay() {
            const total = systemState.predictions.filter(p => p.verified === true).length;
            const correct = systemState.predictions.filter(p => p.correct === true).length;
            const incorrect = systemState.predictions.filter(p => p.correct === false).length;
            const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;
            
            document.getElementById('statCorrect').textContent = correct;
            document.getElementById('statIncorrect').textContent = incorrect;
            document.getElementById('statAccuracy').textContent = `${accuracy}%`;
        }

        function addVIPHistoryLog(prediction) {
            const logContainer = document.getElementById('historyLog');
            const logItem = document.createElement('div');
            logItem.className = 'log-item';
            
            let statusText = 'VIP CHỜ';
            let statusClass = 'log-waiting';
            
            if (prediction.verified === true) {
                statusText = prediction.correct ? 'VIP ĐÚNG' : 'VIP SAI';
                statusClass = prediction.correct ? 'log-correct' : 'log-incorrect';
            }
            
            logItem.innerHTML = `
                <span>#${prediction.targetSession}: <strong>${prediction.prediction}</strong> (${prediction.confidence}%)</span>
                <span class="${statusClass}">${statusText}</span>
            `;
            
            logContainer.insertBefore(logItem, logContainer.firstChild);
            if (logContainer.children.length > 10) logContainer.removeChild(logContainer.lastChild);
        }

        function updateVIPStatus(type, status) {
            const elements = {
                api: document.getElementById('apiStatus'),
                auto: document.getElementById('autoStatus'),
                predict: document.getElementById('predictStatus')
            };
            
            switch(type) {
                case 'api':
                    elements.api.className = status === 'active' ? 'fas fa-circle status-active' :
                                            status === 'loading' ? 'fas fa-circle status-waiting' :
                                            'fas fa-circle status-inactive';
                    break;
                case 'auto':
                    elements.auto.className = status ? 'fas fa-circle status-active' : 'fas fa-circle status-inactive';
                    document.getElementById('autoStatusText').textContent = `Tự động: ${status ? 'BẬT' : 'TẮT'}`;
                    document.getElementById('toggleText').textContent = `TỰ ĐỘNG: ${status ? 'BẬT' : 'TẮT'}`;
                    break;
                case 'predict':
                    elements.predict.className = status === 'processing' ? 'fas fa-circle status-active' :
                                                status === 'waiting' ? 'fas fa-circle status-waiting' :
                                                'fas fa-circle status-inactive';
                    break;
            }
        }

        function toggleAutoMode() {
            systemState.autoMode = !systemState.autoMode;
            updateVIPStatus('auto', systemState.autoMode);
            document.getElementById('toggleSwitch').classList.toggle('active', systemState.autoMode);
            showVIPNotification(`VIP: Tự động ${systemState.autoMode ? 'BẬT' : 'TẮT'}`, systemState.autoMode ? 'success' : 'warning');
            if (systemState.autoMode && systemState.targetSessionId) performVIPPrediction();
        }

        function manualVIPPrediction() {
            if (systemState.dataCache.length < 5) {
                showVIPNotification('VIP: Không đủ dữ liệu', 'error');
                return;
            }
            performVIPPrediction();
        }

        function resetVIPSystem() {
            if (confirm('RESET hệ thống VIP PRO?')) {
                systemState.predictions = [];
                systemState.currentSessionId = null;
                systemState.lastSessionId = null;
                systemState.targetSessionId = null;
                localStorage.removeItem('taixiu_vip_predictions');
                updateVIPSessionDisplay();
                updateVIPStatsDisplay();
                document.getElementById('historyLog').innerHTML = `
                    <div class="log-item">
                        <span>Hệ thống VIP PRO đã reset...</span>
                        <span class="log-waiting">VIP PRO</span>
                    </div>
                `;
                updateVIPPredictionBox('waiting', '---', 'VIP PRO đang khởi động...');
                showVIPNotification('VIP: Đã reset hệ thống', 'info');
            }
        }

        function useVIPSampleData() {
            systemState.dataCache = [
                {id: 6639162, resultTruyenThong: 'TAI', dices: [6,5,5], point: 16},
                {id: 6639161, resultTruyenThong: 'XIU', dices: [2,3,2], point: 7},
                {id: 6639160, resultTruyenThong: 'TAI', dices: [6,4,4], point: 14},
                {id: 6639159, resultTruyenThong: 'XIU', dices: [1,4,1], point: 6},
                {id: 6639158, resultTruyenThong: 'XIU', dices: [1,4,5], point: 10}
            ];
            
            if (!systemState.currentSessionId) {
                systemState.currentSessionId = 6639162;
                systemState.lastSessionId = 6639162;
                systemState.targetSessionId = 6639163;
                updateVIPSessionDisplay();
            }
        }

        function showVIPNotification(message, type) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; padding: 15px 25px; border-radius: 10px;
                color: white; font-weight: bold; z-index: 10000; animation: slideIn 0.5s ease;
                max-width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            `;
            
            if (type === 'success') notification.style.background = 'linear-gradient(90deg, #00b09b, #96c93d)';
            else if (type === 'error') notification.style.background = 'linear-gradient(90deg, #ff416c, #ff4b2b)';
            else if (type === 'warning') notification.style.background = 'linear-gradient(90deg, #f7971e, #ffd200)';
            else notification.style.background = 'linear-gradient(90deg, #2193b0, #6dd5ed)';
            
            notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'crown' : 
                type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;
            
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.5s ease';
                setTimeout(() => notification.remove(), 500);
            }, 5000);
        }

        function saveVIPPredictions() {
            localStorage.setItem('taixiu_vip_predictions', JSON.stringify(systemState.predictions));
        }

        // CSS Animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
