<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAIXIU.AI - Hệ Thống Dự Đoán Tự Động</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #0a0e17;
            --secondary: #00d4ff;
            --accent: #ff375f;
            --success: #00ff9d;
            --warning: #ffb547;
            --text: #e0e0ff;
            --text-muted: #8a8dab;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', monospace;
        }
        body {
            background: var(--primary);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 700px;
            background: rgba(16, 22, 36, 0.95);
            border-radius: 25px;
            border: 2px solid rgba(0, 212, 255, 0.3);
            box-shadow: 0 20px 50px rgba(0, 212, 255, 0.15);
            overflow: hidden;
        }
        .header {
            padding: 25px 30px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
        }
        .header h1 {
            font-size: 1.8rem;
            background: linear-gradient(to right, var(--secondary), var(--success));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
        }
        .system-status {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-active {
            color: var(--success);
        }
        .status-waiting {
            color: var(--warning);
        }
        .status-inactive {
            color: var(--text-muted);
        }
        /* ====== PHẦN THEO DÕI PHIÊN ====== */
        .session-tracker {
            padding: 25px 30px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .tracker-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .tracker-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 10px;
        }
        .tracker-value {
            font-size: 2rem;
            font-weight: 900;
        }
        .current-session {
            color: var(--secondary);
        }
        .next-session {
            color: var(--warning);
        }
        .last-session {
            color: var(--success);
        }
        /* ====== DỰ ĐOÁN CHÍNH ====== */
        .prediction-main {
            padding: 30px;
            text-align: center;
        }
        .prediction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .pred-label {
            font-size: 1.2rem;
            color: var(--text);
        }
        .auto-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 8px 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }
        .toggle-switch {
            width: 40px;
            height: 20px;
            background: rgba(255, 55, 95, 0.3);
            border-radius: 10px;
            position: relative;
            transition: all 0.3s;
        }
        .toggle-switch.active {
            background: rgba(0, 255, 157, 0.3);
        }
        .toggle-knob {
            position: absolute;
            width: 16px;
            height: 16px;
            background: var(--accent);
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s;
        }
        .toggle-switch.active .toggle-knob {
            left: 22px;
            background: var(--success);
        }
        .prediction-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            padding: 40px 20px;
            margin: 20px 0;
            border: 2px solid transparent;
            transition: all 0.5s;
            position: relative;
            overflow: hidden;
        }
        .prediction-box.waiting {
            border-color: var(--warning);
            background: rgba(255, 183, 71, 0.05);
        }
        .prediction-box.ready {
            border-color: var(--secondary);
            background: rgba(0, 212, 255, 0.05);
        }
        .prediction-box.correct {
            border-color: var(--success);
            background: rgba(0, 255, 157, 0.05);
            box-shadow: 0 0 40px rgba(0, 255, 157, 0.3);
        }
        .prediction-box.incorrect {
            border-color: var(--accent);
            background: rgba(255, 55, 95, 0.05);
            box-shadow: 0 0 40px rgba(255, 55, 95, 0.3);
        }
        .result-display {
            font-size: 4rem;
            font-weight: 900;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 5px;
        }
        .tai-result { color: var(--accent); }
        .xiu-result { color: var(--secondary); }
        .confidence-display {
            font-size: 1.5rem;
            color: var(--warning);
            margin-top: 15px;
        }
        .session-target {
            margin-top: 25px;
            font-size: 1.1rem;
            color: var(--text-muted);
        }
        .target-id {
            color: var(--success);
            font-weight: bold;
            font-size: 1.3rem;
            margin-top: 5px;
        }
        /* ====== LỊCH SỬ DỰ ĐOÁN ====== */
        .prediction-history {
            padding: 0 30px 30px;
        }
        .history-title {
            font-size: 1.2rem;
            color: var(--warning);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .history-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        .stat-box {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px 15px;
            text-align: center;
        }
        .stat-value {
            font-size: 2.2rem;
            font-weight: 900;
            margin: 10px 0;
        }
        .correct-stat { color: var(--success); }
        .incorrect-stat { color: var(--accent); }
        .accuracy-stat { color: var(--warning); }
        .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        .history-log {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .log-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.9rem;
        }
        .log-item:last-child { border-bottom: none; }
        .log-correct { color: var(--success); }
        .log-incorrect { color: var(--accent); }
        .log-waiting { color: var(--warning); }
        /* ====== ĐIỀU KHIỂN ====== */
        .control-panel {
            padding: 0 30px 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .btn {
            padding: 18px 25px;
            border-radius: 15px;
            border: none;
            font-weight: bold;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(90deg, var(--secondary), #0088cc);
            color: white;
        }
        .btn-primary:hover {
            background: linear-gradient(90deg, #0088cc, var(--secondary));
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.4);
        }
        .btn-danger {
            background: linear-gradient(90deg, var(--accent), #cc0044);
            color: white;
        }
        .btn-danger:hover {
            background: linear-gradient(90deg, #cc0044, var(--accent));
            box-shadow: 0 5px 20px rgba(255, 55, 95, 0.4);
        }
        /* ====== FOOTER ====== */
        .footer {
            padding: 20px 30px;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.85rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
        }
        .signature {
            color: var(--success);
            font-weight: bold;
            margin-top: 8px;
            letter-spacing: 1px;
        }
        @media (max-width: 650px) {
            .container { border-radius: 20px; }
            .session-tracker { grid-template-columns: 1fr; }
            .history-stats { grid-template-columns: 1fr; }
            .control-panel { grid-template-columns: 1fr; }
            .result-display { font-size: 3rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1><i class="fas fa-satellite"></i> TAIXIU.AI - HỆ THỐNG TỰ ĐỘNG</h1>
            <div class="system-status">
                <div class="status-item">
                    <i class="fas fa-circle" id="apiStatus"></i>
                    <span>Kết nối API</span>
                </div>
                <div class="status-item">
                    <i class="fas fa-circle" id="autoStatus"></i>
                    <span id="autoStatusText">Tự động: TẮT</span>
                </div>
                <div class="status-item">
                    <i class="fas fa-circle" id="predictStatus"></i>
                    <span id="predictStatusText">Đang chờ phiên mới</span>
                </div>
            </div>
        </div>

        <!-- THEO DÕI PHIÊN -->
        <div class="session-tracker">
            <div class="tracker-box">
                <div class="tracker-label">PHIÊN ĐANG DIỄN RA</div>
                <div id="currentSession" class="tracker-value current-session">#---</div>
            </div>
            <div class="tracker-box">
                <div class="tracker-label">PHIÊN SẮP DỰ ĐOÁN</div>
                <div id="targetSession" class="tracker-value next-session">#---</div>
            </div>
            <div class="tracker-box">
                <div class="tracker-label">PHIÊN GẦN NHẤT</div>
                <div id="lastSession" class="tracker-value last-session">#---</div>
            </div>
        </div>

        <!-- DỰ ĐOÁN CHÍNH -->
        <div class="prediction-main">
            <div class="prediction-header">
                <div class="pred-label">
                    <i class="fas fa-crystal-ball"></i> DỰ ĐOÁN PHIÊN TIẾP THEO
                </div>
                <div class="auto-toggle" id="autoToggle">
                    <div class="toggle-switch" id="toggleSwitch">
                        <div class="toggle-knob"></div>
                    </div>
                    <span id="toggleText">TỰ ĐỘNG: TẮT</span>
                </div>
            </div>
            
            <div id="predictionBox" class="prediction-box waiting">
                <div id="resultDisplay" class="result-display">---</div>
                <div id="confidenceDisplay" class="confidence-display">Đang theo dõi phiên hiện tại...</div>
                
                <div class="session-target">
                    <div>ĐANG CHỜ PHIÊN HOÀN TẤT:</div>
                    <div id="waitingSession" class="target-id">#---</div>
                </div>
            </div>

            <div class="session-target" style="margin-top: 20px;">
                <div>DỰ ĐOÁN CHO PHIÊN:</div>
                <div id="predictionForSession" class="target-id">#---</div>
            </div>
        </div>

        <!-- LỊCH SỬ DỰ ĐOÁN -->
        <div class="prediction-history">
            <div class="history-title">
                <i class="fas fa-history"></i> THỐNG KÊ DỰ ĐOÁN
            </div>
            
            <div class="history-stats">
                <div class="stat-box">
                    <div class="stat-value correct-stat" id="statCorrect">0</div>
                    <div class="stat-label">DỰ ĐOÁN ĐÚNG</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value incorrect-stat" id="statIncorrect">0</div>
                    <div class="stat-label">DỰ ĐOÁN SAI</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value accuracy-stat" id="statAccuracy">0%</div>
                    <div class="stat-label">ĐỘ CHÍNH XÁC</div>
                </div>
            </div>

            <div class="history-log" id="historyLog">
                <div class="log-item">
                    <span>Hệ thống đang khởi động...</span>
                    <span class="log-waiting">CHỜ</span>
                </div>
            </div>
        </div>

        <!-- ĐIỀU KHIỂN -->
        <div class="control-panel">
            <button id="manualPredictBtn" class="btn btn-primary">
                <i class="fas fa-bolt"></i> DỰ ĐOÁN THỦ CÔNG
            </button>
            <button id="resetBtn" class="btn btn-danger">
                <i class="fas fa-trash"></i> RESET HỆ THỐNG
            </button>
        </div>

        <!-- FOOTER -->
        <div class="footer">
            <div>Hệ thống tự động theo dõi và dự đoán phiên tiếp theo | API: wtx.tele68.com</div>
            <div class="signature">Wormgpt Cường Dev Don't Delete for copyright | Created by LUKZANMODZ</div>
            <div style="margin-top: 10px; font-size: 0.8rem; color: var(--warning);">
                <i class="fas fa-info-circle"></i> Hệ thống tự động phát hiện phiên mới và dự đoán
            </div>
        </div>
    </div>

    <script>
        // ==================== CẤU HÌNH HỆ THỐNG ====================
        const API_URL = 'https://wtx.tele68.com/v1/tx/lite-sessions';
        
        // Biến hệ thống
        let systemState = {
            autoMode: false,
            currentSessionId: null,
            lastSessionId: null,
            targetSessionId: null,
            isProcessing: false,
            pollInterval: null,
            dataCache: [],
            predictions: [],
            apiErrorCount: 0
        };

        // ==================== KHỞI ĐỘNG ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('TAIXIU.AI - Hệ thống tự động đang khởi động...');
            initializeUI();
            initializeSystem();
            startPolling();
        });

        // ==================== KHỞI TẠO UI ====================
        function initializeUI() {
            // Toggle tự động
            document.getElementById('autoToggle').addEventListener('click', toggleAutoMode);
            
            // Nút thủ công
            document.getElementById('manualPredictBtn').addEventListener('click', manualPrediction);
            
            // Nút reset
            document.getElementById('resetBtn').addEventListener('click', resetSystem);
            
            // Cập nhật thời gian
            updateClock();
            setInterval(updateClock, 1000);
        }

        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('vi-VN');
            document.getElementById('predictStatusText').innerHTML = 
                `<i class="fas fa-clock"></i> ${timeStr}`;
        }

        // ==================== KHỞI TẠO HỆ THỐNG ====================
        function initializeSystem() {
            // Load lịch sử từ localStorage (nếu có)
            const savedPredictions = localStorage.getItem('taixiu_predictions');
            if (savedPredictions) {
                systemState.predictions = JSON.parse(savedPredictions);
                updateStatsDisplay();
            }
            
            // Bắt đầu polling
            startPolling();
        }

        // ==================== POLLING TỰ ĐỘNG ====================
        function startPolling() {
            // Dừng interval cũ nếu có
            if (systemState.pollInterval) {
                clearInterval(systemState.pollInterval);
            }
            
            // Poll mỗi 10 giây
            systemState.pollInterval = setInterval(async () => {
                if (systemState.isProcessing) return;
                
                try {
                    systemState.isProcessing = true;
                    await checkNewSession();
                } catch (error) {
                    console.error('Lỗi polling:', error);
                    updateStatus('api', 'error');
                    systemState.apiErrorCount++;
                    
                    if (systemState.apiErrorCount > 5) {
                        showNotification('Lỗi API liên tục. Đang thử lại...', 'error');
                    }
                } finally {
                    systemState.isProcessing = false;
                }
            }, 10000); // 10 giây
            
            // Poll ngay lập tức lần đầu
            setTimeout(() => checkNewSession(), 1000);
        }

        // ==================== KIỂM TRA PHIÊN MỚI ====================
        async function checkNewSession() {
            updateStatus('api', 'loading');
            
            try {
                const response = await fetch(API_URL + '?t=' + Date.now());
                if (!response.ok) throw new Error('API không phản hồi');
                
                const data = await response.json();
                updateStatus('api', 'active');
                systemState.apiErrorCount = 0;
                
                if (!data.list || data.list.length === 0) {
                    throw new Error('Dữ liệu API trống');
                }
                
                // Lấy phiên mới nhất
                const latestSession = data.list[0];
                const latestSessionId = latestSession.id;
                
                // Cập nhật dữ liệu cache
                systemState.dataCache = data.list.slice(0, 20);
                
                // Kiểm tra xem có phiên mới không
                if (systemState.lastSessionId === null) {
                    // Lần đầu khởi động
                    systemState.currentSessionId = latestSessionId;
                    systemState.lastSessionId = latestSessionId;
                    systemState.targetSessionId = latestSessionId + 1;
                    
                    updateSessionDisplay();
                    showNotification(`Đã kết nối API. Phiên hiện tại: #${latestSessionId}`, 'success');
                    
                } else if (latestSessionId > systemState.lastSessionId) {
                    // Có phiên mới!
                    systemState.lastSessionId = latestSessionId;
                    
                    // Kiểm tra xem có cần xác nhận dự đoán trước đó không
                    checkPredictionResult();
                    
                    // Cập nhật phiên hiện tại
                    systemState.currentSessionId = latestSessionId;
                    systemState.targetSessionId = latestSessionId + 1;
                    
                    updateSessionDisplay();
                    showNotification(`Đã phát hiện phiên mới: #${latestSessionId}`, 'info');
                    
                    // Nếu đang ở chế độ tự động, thực hiện dự đoán
                    if (systemState.autoMode) {
                        setTimeout(() => performPrediction(), 2000);
                    }
                    
                } else {
                    // Chưa có phiên mới, chỉ cập nhật hiển thị
                    updateSessionDisplay();
                    updateStatus('predict', 'waiting');
                }
                
            } catch (error) {
                console.error('Lỗi khi kiểm tra phiên:', error);
                updateStatus('api', 'error');
                
                // Dùng dữ liệu mẫu nếu API lỗi
                useSampleData();
            }
        }

        // ==================== KIỂM TRA KẾT QUẢ DỰ ĐOÁN ====================
        function checkPredictionResult() {
            if (systemState.predictions.length === 0) return;
            
            const lastPrediction = systemState.predictions[systemState.predictions.length - 1];
            
            // Chỉ kiểm tra nếu dự đoán chưa được xác nhận
            if (lastPrediction.verified === false && lastPrediction.targetSession === systemState.lastSessionId) {
                // Tìm kết quả thực tế của phiên này
                const actualSession = systemState.dataCache.find(s => s.id === lastPrediction.targetSession);
                
                if (actualSession) {
                    const actualResult = actualSession.resultTruyenThong;
                    const isCorrect = lastPrediction.prediction === actualResult;
                    
                    // Cập nhật dự đoán
                    lastPrediction.actual = actualResult;
                    lastPrediction.correct = isCorrect;
                    lastPrediction.verified = true;
                    lastPrediction.verifiedAt = new Date().toISOString();
                    
                    // Cập nhật UI
                    updatePredictionBox(isCorrect ? 'correct' : 'incorrect', 
                                      lastPrediction.prediction, 
                                      `${lastPrediction.confidence}% (${isCorrect ? 'ĐÚNG' : 'SAI'})`);
                    
                    // Cập nhật thống kê
                    updateStatsDisplay();
                    addHistoryLog(lastPrediction);
                    
                    // Hiển thị thông báo
                    showNotification(`Dự đoán cho phiên #${lastPrediction.targetSession}: ${isCorrect ? 'ĐÚNG' : 'SAI'}`, 
                                   isCorrect ? 'success' : 'error');
                    
                    // Lưu vào localStorage
                    savePredictions();
                }
            }
        }

        // ==================== THỰC HIỆN DỰ ĐOÁN ====================
        function performPrediction() {
            if (systemState.dataCache.length < 3) {
                showNotification('Cần ít nhất 3 phiên để phân tích', 'warning');
                return;
            }
            
            updateStatus('predict', 'processing');
            
            // Phân tích dữ liệu
            const analysis = analyzeData(systemState.dataCache);
            
            // Tạo dự đoán
            const prediction = {
                id: Date.now(),
                prediction: analysis.result,
                confidence: analysis.confidence,
                targetSession: systemState.targetSessionId,
                createdAt: new Date().toISOString(),
                verified: false,
                actual: null,
                correct: null
            };
            
            // Thêm vào lịch sử
            systemState.predictions.push(prediction);
            
            // Cập nhật UI
            updatePredictionBox('ready', prediction.prediction, `${prediction.confidence}%`);
            updateSessionDisplay();
            
            // Thêm vào log
            addHistoryLog(prediction);
            
            // Lưu vào localStorage
            savePredictions();
            
            // Hiển thị thông báo
            showNotification(`Đã dự đoán phiên #${prediction.targetSession}: ${prediction.prediction}`, 'info');
            
            // Cập nhật trạng thái
            updateStatus('predict', 'waiting');
        }

        // ==================== THUẬT TOÁN PHÂN TÍCH ====================
        function analyzeData(sessions) {
            const recent = sessions.slice(0, 10);
            
            // 1. Tính tỷ lệ gần đây
            const taiCount = recent.filter(s => s.resultTruyenThong === 'TAI').length;
            const xiuCount = recent.length - taiCount;
            const taiRatio = taiCount / recent.length;
            
            // 2. Tính điểm trung bình
            const avgPoint = recent.reduce((sum, s) => sum + s.point, 0) / recent.length;
            
            // 3. Phát hiện chuỗi
            let currentStreak = 1;
            const firstResult = recent[0].resultTruyenThong;
            for (let i = 1; i < recent.length; i++) {
                if (recent[i].resultTruyenThong === firstResult) {
                    currentStreak++;
                } else {
                    break;
                }
            }
            
            // 4. Tính điểm cho từng bên
            let taiScore = 50;
            let xiuScore = 50;
            
            // Tỷ lệ gần đây
            taiScore += (taiRatio - 0.5) * 40;
            xiuScore += ((1 - taiRatio) - 0.5) * 40;
            
            // Điểm trung bình
            if (avgPoint > 10.5) {
                taiScore += (avgPoint - 10.5) * 10;
            } else {
                xiuScore += (10.5 - avgPoint) * 10;
            }
            
            // Chuỗi hiện tại (nếu có chuỗi dài -> dễ đảo chiều)
            if (currentStreak >= 2) {
                if (firstResult === 'TAI') {
                    xiuScore += currentStreak * 15;
                } else {
                    taiScore += currentStreak * 15;
                }
            }
            
            // 5. Quyết định kết quả
            const totalScore = taiScore + xiuScore;
            const taiPercent = Math.round((taiScore / totalScore) * 100);
            const xiuPercent = 100 - taiPercent;
            
            const result = taiPercent > xiuPercent ? 'TAI' : 'XIU';
            const confidence = Math.max(taiPercent, xiuPercent);
            
            return {
                result: result,
                confidence: confidence,
                analysis: {
                    taiRatio: taiRatio,
                    avgPoint: avgPoint,
                    currentStreak: currentStreak,
                    firstResult: firstResult
                }
            };
        }

        // ==================== CẬP NHẬT UI ====================
        function updateSessionDisplay() {
            // Phiên đang diễn ra
            document.getElementById('currentSession').textContent = 
                systemState.currentSessionId ? `#${systemState.currentSessionId}` : '#---';
            
            // Phiên mục tiêu (sẽ dự đoán)
            document.getElementById('targetSession').textContent = 
                systemState.targetSessionId ? `#${systemState.targetSessionId}` : '#---';
            
            // Phiên gần nhất
            document.getElementById('lastSession').textContent = 
                systemState.lastSessionId ? `#${systemState.lastSessionId}` : '#---';
            
            // Phiên đang chờ
            document.getElementById('waitingSession').textContent = 
                systemState.currentSessionId ? `#${systemState.currentSessionId}` : '#---';
            
            // Phiên sẽ dự đoán
            document.getElementById('predictionForSession').textContent = 
                systemState.targetSessionId ? `#${systemState.targetSessionId}` : '#---';
        }

        function updatePredictionBox(state, result, confidence) {
            const box = document.getElementById('predictionBox');
            const resultEl = document.getElementById('resultDisplay');
            const confidenceEl = document.getElementById('confidenceDisplay');
            
            // Cập nhật class
            box.className = 'prediction-box ' + state;
            
            // Cập nhật nội dung
            resultEl.textContent = result;
            resultEl.className = 'result-display ' + (result === 'TAI' ? 'tai-result' : 'xiu-result');
            confidenceEl.textContent = confidence;
            
            // Hiệu ứng
            box.style.transform = 'scale(1.05)';
            setTimeout(() => {
                box.style.transform = 'scale(1)';
            }, 300);
        }

        function updateStatsDisplay() {
            const total = systemState.predictions.filter(p => p.verified === true).length;
            const correct = systemState.predictions.filter(p => p.correct === true).length;
            const incorrect = systemState.predictions.filter(p => p.correct === false).length;
            const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;
            
            document.getElementById('statCorrect').textContent = correct;
            document.getElementById('statIncorrect').textContent = incorrect;
            document.getElementById('statAccuracy').textContent = `${accuracy}%`;
        }

        function addHistoryLog(prediction) {
            const logContainer = document.getElementById('historyLog');
            const logItem = document.createElement('div');
            logItem.className = 'log-item';
            
            let statusText = 'CHỜ';
            let statusClass = 'log-waiting';
            
            if (prediction.verified === true) {
                statusText = prediction.correct ? 'ĐÚNG' : 'SAI';
                statusClass = prediction.correct ? 'log-correct' : 'log-incorrect';
            }
            
            logItem.innerHTML = `
                <span>Phiên #${prediction.targetSession}: <strong>${prediction.prediction}</strong> (${prediction.confidence}%)</span>
                <span class="${statusClass}">${statusText}</span>
            `;
            
            // Thêm vào đầu
            logContainer.insertBefore(logItem, logContainer.firstChild);
            
            // Giới hạn số lượng log
            if (logContainer.children.length > 10) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        // ==================== QUẢN LÝ TRẠNG THÁI ====================
        function updateStatus(type, status) {
            const apiStatus = document.getElementById('apiStatus');
            const autoStatus = document.getElementById('autoStatus');
            const predictStatus = document.getElementById('predictStatus');
            
            switch(type) {
                case 'api':
                    apiStatus.className = status === 'active' ? 'fas fa-circle status-active' :
                                         status === 'loading' ? 'fas fa-circle status-waiting' :
                                         'fas fa-circle status-inactive';
                    break;
                    
                case 'auto':
                    autoStatus.className = status ? 'fas fa-circle status-active' : 'fas fa-circle status-inactive';
                    document.getElementById('autoStatusText').textContent = `Tự động: ${status ? 'BẬT' : 'TẮT'}`;
                    document.getElementById('toggleText').textContent = `TỰ ĐỘNG: ${status ? 'BẬT' : 'TẮT'}`;
                    break;
                    
                case 'predict':
                    predictStatus.className = status === 'processing' ? 'fas fa-circle status-active' :
                                             status === 'waiting' ? 'fas fa-circle status-waiting' :
                                             'fas fa-circle status-inactive';
                    break;
            }
        }

        function toggleAutoMode() {
            systemState.autoMode = !systemState.autoMode;
            updateStatus('auto', systemState.autoMode);
            
            const toggleSwitch = document.getElementById('toggleSwitch');
            toggleSwitch.classList.toggle('active', systemState.autoMode);
            
            showNotification(`Chế độ tự động: ${systemState.autoMode ? 'BẬT' : 'TẮT'}`, 
                           systemState.autoMode ? 'success' : 'warning');
            
            // Nếu bật tự động và có phiên mục tiêu, thực hiện dự đoán ngay
            if (systemState.autoMode && systemState.targetSessionId) {
                performPrediction();
            }
        }

        // ==================== XỬ LÝ THỦ CÔNG ====================
        function manualPrediction() {
            if (systemState.dataCache.length < 3) {
                showNotification('Không đủ dữ liệu để dự đoán', 'error');
                return;
            }
            
            performPrediction();
        }

        // ==================== RESET HỆ THỐNG ====================
        function resetSystem() {
            if (confirm('RESET toàn bộ hệ thống? Lịch sử dự đoán sẽ bị xóa.')) {
                systemState.predictions = [];
                systemState.currentSessionId = null;
                systemState.lastSessionId = null;
                systemState.targetSessionId = null;
                
                // Xóa localStorage
                localStorage.removeItem('taixiu_predictions');
                
                // Reset UI
                updateSessionDisplay();
                updateStatsDisplay();
                document.getElementById('historyLog').innerHTML = `
                    <div class="log-item">
                        <span>Hệ thống đã được reset...</span>
                        <span class="log-waiting">CHỜ</span>
                    </div>
                `;
                
                updatePredictionBox('waiting', '---', 'Đang khởi động lại...');
                showNotification('Đã reset toàn bộ hệ thống', 'info');
            }
        }

        // ==================== TIỆN ÍCH ====================
        function useSampleData() {
            // Dữ liệu mẫu khi API lỗi
            systemState.dataCache = [
                {id: 6639160, resultTruyenThong: 'TAI', dices: [6,4,4], point: 14},
                {id: 6639159, resultTruyenThong: 'XIU', dices: [1,4,1], point: 6},
                {id: 6639158, resultTruyenThong: 'XIU', dices: [1,4,5], point: 10},
                {id: 6639157, resultTruyenThong: 'TAI', dices: [6,2,5], point: 13}
            ];
            
            if (!systemState.currentSessionId) {
                systemState.currentSessionId = 6639160;
                systemState.lastSessionId = 6639160;
                systemState.targetSessionId = 6639161;
                updateSessionDisplay();
            }
        }

        function showNotification(message, type) {
            // Tạo notification tạm thời
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 10px;
                color: white;
                font-weight: bold;
                z-index: 10000;
                animation: slideIn 0.5s ease;
                max-width: 400px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            `;
            
            if (type === 'success') {
                notification.style.background = 'linear-gradient(90deg, #00b09b, #96c93d)';
            } else if (type === 'error') {
                notification.style.background = 'linear-gradient(90deg, #ff416c, #ff4b2b)';
            } else if (type === 'warning') {
                notification.style.background = 'linear-gradient(90deg, #f7971e, #ffd200)';
            } else {
                notification.style.background = 'linear-gradient(90deg, #2193b0, #6dd5ed)';
            }
            
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 
                                  type === 'error' ? 'exclamation-circle' : 
                                  'info-circle'}"></i>
                ${message}
            `;
            
            document.body.appendChild(notification);
            
            // Tự động xóa sau 5 giây
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.5s ease';
                setTimeout(() => notification.remove(), 500);
            }, 5000);
        }

        function savePredictions() {
            localStorage.setItem('taixiu_predictions', JSON.stringify(systemState.predictions));
        }

        // Thêm CSS animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
